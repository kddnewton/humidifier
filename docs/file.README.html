<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Humidifier
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "README";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'>
<h1 id="label-Humidifier">Humidifier</h1>

<p><a href="https://github.com/kddnewton/humidifier/actions"><img src="https://github.com/kddnewton/humidifier/workflows/Main/badge.svg"></a> <a href="https://rubygems.org/gems/humidifier"><img src="https://img.shields.io/gem/v/humidifier.svg"></a></p>

<p>Humidifier is a ruby tool for managing <a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation</a> stacks. You can use it to build and manage stacks programmatically or you can use it as a command line tool to manage stacks through configuration files.</p>
<ul><li>
<p><a href="#installation">Installation</a></p>
</li><li>
<p><a href="#getting-started">Getting started</a></p>
</li><li>
<p><a href="#example-usage">Example usage</a></p>
</li><li>
<p><a href="#interfacing-with-aws">Interfacing with AWS</a></p>
<ul><li>
<p><a href="#cloudformation-functions">CloudFormation functions</a></p>
</li><li>
<p><a href="#change-sets">Change Sets</a></p>
</li></ul>
</li><li>
<p><a href="#introspection">Introspection</a></p>
</li><li>
<p><a href="#large-templates">Large templates</a></p>
</li><li>
<p><a href="#forcing-uploading">Forcing uploading</a></p>
</li><li>
<p><a href="#cli">CLI</a></p>
</li><li>
<p><a href="#resource-files">Resource files</a></p>
</li><li>
<p><a href="#mappers">Mappers</a></p>
</li><li>
<p><a href="#using-the-cli">Using the CLI</a></p>
<ul><li>
<p>[?stack]</code><a href="#change-stack"></a></p>
</li><li>
<p>[?stack] [*parameters]</code><a href="#deploy-stack-parameters"></a></p>
</li><li>
<p>[stack] [?pattern]</code><a href="#display-stack-pattern"></a></p>
</li><li>
<p>href="#stacks"></a></p>
</li><li>
<p>href="#upgrade"></a></p>
</li><li>
<p>[?stack]</code><a href="#upload-stack"></a></p>
</li><li>
<p>[?stack]</code><a href="#validate-stack"></a></p>
</li></ul>
</li><li>
<p><a href="#parameters">Parameters</a></p>
</li><li>
<p><a href="#shortcuts">Shortcuts</a></p>
<ul><li>
<p><a href="#automatic-id-properties">Automatic id properties</a></p>
</li><li>
<p><a href="#anonymous-mappers">Anonymous mappers</a></p>
</li><li>
<p><a href="#cross-stack-references">Cross-stack references</a></p>
</li></ul>
</li><li>
<p><a href="#development">Development</a></p>
</li><li>
<p><a href="#testing">Testing</a></p>
</li><li>
<p><a href="#specs">Specs</a></p>
</li><li>
<p><a href="#contributing">Contributing</a></p>
</li><li>
<p><a href="#license">License</a></p>
</li></ul>

<h2 id="label-Installation">Installation</h2>

<p>Add this line to your application’s Gemfile:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>humidifier</span><span class='tstring_end'>&#39;</span></span>
</code></pre>

<p>And then execute:</p>

<pre class="code ruby"><code class="ruby">$ bundle
</code></pre>

<p>Or install it yourself as:</p>

<pre class="code ruby"><code class="ruby">$ gem install humidifier
</code></pre>

<h2 id="label-Getting+started">Getting started</h2>

<p>Stacks are represented by the <code>Humidifier::Stack</code> class. You can set any of the top-level JSON attributes (such as <code>name</code> and <code>description</code>) through the initializer.</p>

<p>Resources are represented by an exact mapping from <code>AWS</code> resource names to <code>Humidifier</code> resources names (e.g. <code>AWS::EC2::Instance</code> becomes <code>Humidifier::EC2::Instance</code>). Resources have accessors for each JSON attribute. Each attribute can also be set through the <code>initialize</code>, <code>update</code>, and <code>update_attribute</code> methods.</p>

<h3 id="label-Example+usage">Example usage</h3>

<p>The below example will create a stack with two resources, a loader balancer and an auto scaling group. It then deploys the new stack and pauses execution until the stack is finished being created.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_stack'>stack</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Humidifier.html" title="Humidifier (module)">Humidifier</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Humidifier/Stack.html" title="Humidifier::Stack (class)">Stack</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Humidifier/Stack.html#initialize-instance_method" title="Humidifier::Stack#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Example-Stack</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

<span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>LoaderBalancer</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='const'><span class='object_link'><a href="Humidifier.html" title="Humidifier (module)">Humidifier</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Humidifier/ElasticLoadBalancing.html" title="Humidifier::ElasticLoadBalancing (module)">ElasticLoadBalancing</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Humidifier/ElasticLoadBalancing/LoadBalancer.html" title="Humidifier::ElasticLoadBalancing::LoadBalancer (class)">LoadBalancer</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Humidifier/Resource.html#initialize-instance_method" title="Humidifier::Resource#initialize (method)">new</a></span></span><span class='lparen'>(</span>
    <span class='label'>scheme:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>internal</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
    <span class='label'>listeners:</span> <span class='lbracket'>[</span>
      <span class='lbrace'>{</span>
        <span class='label'>load_balancer_port:</span> <span class='int'>80</span><span class='comma'>,</span>
        <span class='label'>protocol:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>http</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
        <span class='label'>instance_port:</span> <span class='int'>80</span><span class='comma'>,</span>
        <span class='label'>instance_protocol:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>http</span><span class='tstring_end'>&#39;</span></span>
      <span class='rbrace'>}</span>
    <span class='rbracket'>]</span>
  <span class='rparen'>)</span>
<span class='rparen'>)</span>

<span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AutoScalingGroup</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='const'><span class='object_link'><a href="Humidifier.html" title="Humidifier (module)">Humidifier</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Humidifier/AutoScaling.html" title="Humidifier::AutoScaling (module)">AutoScaling</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Humidifier/AutoScaling/AutoScalingGroup.html" title="Humidifier::AutoScaling::AutoScalingGroup (class)">AutoScalingGroup</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Humidifier/Resource.html#initialize-instance_method" title="Humidifier::Resource#initialize (method)">new</a></span></span><span class='lparen'>(</span>
    <span class='label'>min_size:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
    <span class='label'>max_size:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>20</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
    <span class='label'>availability_zones:</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>us-east-1a</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>load_balancer_names:</span> <span class='lbracket'>[</span><span class='const'><span class='object_link'><a href="Humidifier.html" title="Humidifier (module)">Humidifier</a></span></span><span class='period'>.</span><span class='id identifier rubyid_ref'><span class='object_link'><a href="Humidifier.html#ref-class_method" title="Humidifier.ref (method)">ref</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>LoadBalancer</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='rbracket'>]</span>
  <span class='rparen'>)</span>
<span class='rparen'>)</span>

<span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_deploy_and_wait'>deploy_and_wait</span>
</code></pre>

<h3 id="label-Interfacing+with+AWS">Interfacing with AWS</h3>

<p>Once stacks have the appropriate resources, you can query AWS to handle all stack CRUD operations. The operations themselves are intuitively named (i.e. <code>#create</code>, <code>#update</code>, <code>#delete</code>). There are also convenience methods for validating a stack body (<code>#valid?</code>), checking the existence of a stack (<code>#exists?</code>), and creating or updating based on existence (<code>#deploy</code>).</p>

<p>There are additionally four functions on <code>Humidifier::Stack</code> that support waiting for execution in AWS to finish. They all have non-blocking corollaries, and are named after them. They are: <code>#create_and_wait</code>, <code>#update_and_wait</code>, <code>#delete_and_wait</code>, and <code>#deploy_and_wait</code>.</p>

<h4 id="label-CloudFormation+functions">CloudFormation functions</h4>

<p>You can use CFN intrinsic functions and references using <code>Humidifier.fn.[name]</code> and <code>Humidifier.ref</code>. They will build appropriate structures that know how to be dumped to CFN syntax.</p>

<h4 id="label-Change+Sets">Change Sets</h4>

<p>Instead of immediately pushing your changes to CloudFormation, Humidifier also supports change sets. Change sets are a powerful feature that allow you to see the changes that will be made before you make them. To read more about change sets see the <a href="https://aws.amazon.com/blogs/aws/new-change-sets-for-aws-cloudformation/">announcement article</a>. To use them in Humidifier, <code>Humidifier::Stack</code> has the <code>#create_change_set</code> and <code>#deploy_change_set</code> methods. The <code>#create_change_set</code> method will create a change set on the stack. The <code>#deploy_change_set</code> method will create a change set if the stack currently exists, and otherwise will create the stack.</p>

<h3 id="label-Introspection">Introspection</h3>

<p>To see the template body, you can check the <code>#to_cf</code> method on stacks, resources, fns, and refs. All of them will output a hash of what will be uploaded (except the stack, which will output a string representation).</p>

<p>Humidifier itself contains a registry of all possible resources that it supports. You can access it with <code>Humidifier::registry</code> which is a hash of AWS resource name pointing to the class.</p>

<p>Resources have an <code>::aws_name</code> method to see how AWS references them. They also contain a <code>::props</code> method that contains a hash of the name that Humidifier uses to reference the prop pointing to the appropriate prop object.</p>

<h3 id="label-Large+templates">Large templates</h3>

<p>When templates are especially large (larger than 51,200 bytes), they cannot be uploaded directly through the AWS SDK. You can configure <code>Humidifier</code> to seamlessly upload the templates to S3 and reference them using an S3 URL instead by:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><span class='object_link'><a href="Humidifier.html" title="Humidifier (module)">Humidifier</a></span></span><span class='period'>.</span><span class='id identifier rubyid_configure'><span class='object_link'><a href="Humidifier.html#configure-class_method" title="Humidifier.configure (method)">configure</a></span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_s3_bucket'>s3_bucket</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>my.s3.bucket</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_s3_prefix'>s3_prefix</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>my-prefix/</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># optional
</span><span class='kw'>end</span>
</code></pre>

<h3 id="label-Forcing+uploading">Forcing uploading</h3>

<p>You can force a stack to upload its template to S3 regardless of the size of the template. This is a useful option if you’re going to be deploying multiple copies of a template or if you want a backup. You can set this option on a per-stack basis:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_stack'>stack</span><span class='period'>.</span><span class='id identifier rubyid_deploy'>deploy</span><span class='lparen'>(</span><span class='label'>force_upload:</span> <span class='kw'>true</span><span class='rparen'>)</span>
</code></pre>

<p>or globally, by setting the configuration option:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><span class='object_link'><a href="Humidifier.html" title="Humidifier (module)">Humidifier</a></span></span><span class='period'>.</span><span class='id identifier rubyid_configure'><span class='object_link'><a href="Humidifier.html#configure-class_method" title="Humidifier.configure (method)">configure</a></span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_force_upload'>force_upload</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='kw'>end</span>
</code></pre>

<h2 id="label-CLI">CLI</h2>

<p><code>Humidifier</code> can also be used as a CLI for managing resources through configuration files. For a step-by-step guide, read on, but if you’d like to see a working example, check out the <a href="example">example directory</a>.</p>

<p>To get started, build a ruby script (for example <code>humidifier</code>) that executes the <code>Humidifier::CLI</code> class, like so:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'>#!/usr/bin/env ruby
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>humidifier</span><span class='tstring_end'>&#39;</span></span>

<span class='const'><span class='object_link'><a href="Humidifier.html" title="Humidifier (module)">Humidifier</a></span></span><span class='period'>.</span><span class='id identifier rubyid_configure'><span class='object_link'><a href="Humidifier.html#configure-class_method" title="Humidifier.configure (method)">configure</a></span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='comment'># optional, defaults to the current working directory, so that all of the
</span>  <span class='comment'># directories from the location that you run the CLI are assumed to contain
</span>  <span class='comment'># resource specifications
</span>  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_stack_path'>stack_path</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>stacks</span><span class='tstring_end'>&#39;</span></span>

  <span class='comment'># optional, a default prefix to use before deploying to AWS
</span>  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_stack_prefix'>stack_prefix</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>humidifier-</span><span class='tstring_end'>&#39;</span></span>

  <span class='comment'># specifies that `users.yml` files contain specifications for `AWS::IAM::User`
</span>  <span class='comment'># resources
</span>  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='symbol'>:users</span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>IAM::User</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='const'><span class='object_link'><a href="Humidifier.html" title="Humidifier (module)">Humidifier</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Humidifier/CLI.html" title="Humidifier::CLI (class)">CLI</a></span></span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span><span class='lparen'>(</span><span class='const'>ARGV</span><span class='rparen'>)</span>
</code></pre>

<h3 id="label-Resource+files">Resource files</h3>

<p>Inside of the <code>stacks</code> directory configured above, create a subdirectory for each CloudFormation stack that you want to deploy. With the above configuration, we can create YAML files in the form of <code>users.yml</code> for each stack, which will specify IAM users to create. The file format looks like the below:</p>

<pre class="code ruby"><code class="ruby">EngUser:
  path: /humidifier/
  user_name: EngUser
  groups:
  - Engineering
  - Testing
  - Deployment

AdminUser:
  path: /humidifier/
  user_name: AdminUser
  groups:
  - Management
  - Administration
</code></pre>

<p>The top-level keys are the logical resource names that will be displayed in the CloudFormation screen. They point to a map of key/value pairs that will be passed on to <code>humidifier</code>. Any <code>humidifier</code> (and therefore any CloudFormation) attribute may be specified. For more information on CloudFormation templates and which attributes may be specified, see both the docs[http://kddnewton.github.io/humidifier] and the <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html">CloudFormation docs</a>.</p>

<h3 id="label-Mappers">Mappers</h3>

<p>Oftentimes, specifying these attributes can become repetitive, e.g., each user should automatically receive the same “path” attribute. Other times, you may want custom logic to execute depending on which AWS environment you’re running in. Finally, you may want to reference resources in the same or other stacks.</p>

<p><code>Humidifier</code>‘s solution for this is to allow customized “mapper” classes to take the user-provided attributes and transform them into the attributes that CloudFormation expects. Consider the following example for mapping a user:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>UserMapper</span> <span class='op'>&lt;</span> <span class='const'><span class='object_link'><a href="Humidifier.html" title="Humidifier (module)">Humidifier</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Humidifier/Config.html" title="Humidifier::Config (class)">Config</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Humidifier/Config/Mapper.html" title="Humidifier::Config::Mapper (class)">Mapper</a></span></span>
  <span class='const'>GROUPS</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>eng</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='qwords_beg'>%w[</span><span class='tstring_content'>Engineering</span><span class='words_sep'> </span><span class='tstring_content'>Testing</span><span class='words_sep'> </span><span class='tstring_content'>Deployment</span><span class='tstring_end'>]</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='qwords_beg'>%w[</span><span class='tstring_content'>Management</span><span class='words_sep'> </span><span class='tstring_content'>Administration</span><span class='tstring_end'>]</span></span>
  <span class='rbrace'>}</span>

  <span class='id identifier rubyid_defaults'>defaults</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_logical_name'>logical_name</span><span class='op'>|</span>
    <span class='lbrace'>{</span> <span class='label'>path:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/humidifier/</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>user_name:</span> <span class='id identifier rubyid_logical_name'>logical_name</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attribute'>attribute</span> <span class='symbol'>:group</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_group'>group</span><span class='op'>|</span>
    <span class='id identifier rubyid_groups'>groups</span> <span class='op'>=</span> <span class='const'>GROUPS</span><span class='lbracket'>[</span><span class='id identifier rubyid_group'>group</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_groups'>groups</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span> <span class='op'>?</span> <span class='lbrace'>{</span> <span class='label'>groups:</span> <span class='const'>GROUPS</span><span class='lbracket'>[</span><span class='id identifier rubyid_group'>group</span><span class='rbracket'>]</span> <span class='rbrace'>}</span> <span class='op'>:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'><span class='object_link'><a href="Humidifier.html" title="Humidifier (module)">Humidifier</a></span></span><span class='period'>.</span><span class='id identifier rubyid_configure'><span class='object_link'><a href="Humidifier.html#configure-class_method" title="Humidifier.configure (method)">configure</a></span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='symbol'>:users</span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>IAM::User</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>using:</span> <span class='const'>UserMapper</span>
<span class='kw'>end</span>
</code></pre>

<p>This means that by default, all entries in the <code>users.yml</code> files will get a <code>/humidifier/</code> path, the <code>user_name</code> attribute will be set based on the logical name that was provided for the resource, and you can additionally specify a <code>group</code> attribute, even though it is not native to CloudFormation. With this <code>group</code> attribute, it will actually map to the <code>groups</code> attribute that CloudFormation expects.</p>

<p>With this new mapper in place, we can simplify our YAML file to:</p>

<pre class="code ruby"><code class="ruby">EngUser:
  group: eng

AdminUser:
  group: admin
</code></pre>

<h3 id="label-Using+the+CLI">Using the CLI</h3>

<p>Now that you’ve configured your CLI, your resources, and your mappers, you can use the CLI to display, validate, and deploy your infrastructure to CloudFormation. Run your script without any arguments to get the help message and explanations for each command.</p>

<p>Each command has an <code>--aws-profile</code> (or <code>-p</code>) option for specifying which profile to authenticate against when querying AWS. You should ensure that this profile has the correct permissions for creating whatever resources are going to part of your stack. You can also rely on the <code>AWS_*</code> environment variables, or the EC2 instance profile if you’re deploying from an instance. For more information, see the <a href="http://docs.aws.amazon.com/sdkforruby/api/">AWS docs</a> under the “Configuration” section.</p>

<p>Below are the list of commands and some of their options.</p>

<h4 id="label-change+-5B-3Fstack-5D"><code>change [?stack]</code></h4>

<p>Creates a change set for either the specified stack or all stacks in the repo. The change set represents the changes between what is currently deployed versus the resources represented by the configuration.</p>

<h4 id="label-deploy+-5B-3Fstack-5D+-5B-2Aparameters-5D"><code>deploy [?stack] [*parameters]</code></h4>

<p>Creates or updates (depending on if the stack already exists) one or all stacks in the repo.</p>

<p>The <code>deploy</code> command also allows a <code>--prefix</code> command line argument that will override the default prefix (if one is configured) for the stack that is being deployed. This is especially useful when you’re deploying multiple copies of the same stack (for instance, multiple autoscaling groups) that have different purposes or semantically mean newer versions of resources.</p>

<h4 id="label-display+-5Bstack-5D+-5B-3Fpattern-5D"><code>display [stack] [?pattern]</code></h4>

<p>Displays the specified stack in JSON format on the command line. If you optionally pass a pattern argument, it will filter the resources down to just ones whose names match the given pattern.</p>

<h4 id="label-stacks"><code>stacks</code></h4>

<p>Displays the names of all of the stacks that <code>humidifier</code> is managing.</p>

<h4 id="label-upgrade"><code>upgrade</code></h4>

<p>Downloads the latest CloudFormation resource specification. Periodically AWS will update the file that <code>humidifier</code> is based on, in which case the attributes of the resources that were changed could change. This gem usually stays relatively in sync, but if you need to use the latest specs and this gem has not yet released a new version containing them, then you can run this command to download the latest specs onto your system.</p>

<h4 id="label-upload+-5B-3Fstack-5D"><code>upload [?stack]</code></h4>

<p>Upload one or all stacks in the repo to S3 for reference later. Note that this must be combined with the <code>humidifier</code> <code>s3_bucket</code> configuration option.</p>

<h4 id="label-validate+-5B-3Fstack-5D"><code>validate [?stack]</code></h4>

<p>Validate that one or all stacks in the repo are properly configured and using values that CloudFormation understands.</p>

<h3 id="label-Parameters">Parameters</h3>

<p>CloudFormation template parameters can be specified by having a special <code>parameters.yml</code> file in your stack directory. This file should contain a YAML-encoded object whose keys are the names of the parameters and whose values are the parameter configuration (using the same underscore paradigm as <code>humidifier</code> resources for specifying configuration).</p>

<p>You can pass values to the CLI deploy command after the stack name on the command line as in:</p>

<pre class="code ruby"><code class="ruby">humidifier deploy foobar Param1=Foo Param2=Bar
</code></pre>

<p>Those parameters will get passed in as values when the stack is deployed.</p>

<h3 id="label-Shortcuts">Shortcuts</h3>

<p>A couple of convenient shortcuts are built into <code>humidifier</code> so that writing templates and mappers both can be more concise.</p>

<h4 id="label-Automatic+id+properties">Automatic id properties</h4>

<p>There are a lot of properties in the AWS CloudFormation resource specification that are simply pointers to other entities within the AWS ecosystem. For example, an <code>AWS::EC2::VPCGatewayAttachment</code> entity has a <code>VpcId</code> property that represents the ID of the associated <code>AWS::EC2::VPC</code>.</p>

<p>Because this pattern is so common, <code>humidifier</code> detects all properties ending in <code>Id</code> and allows you to specify them without the suffix. If you choose to use this format, <code>humidifier</code> will automatically turn that value into a <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-ref.html">CloudFormation resource reference</a>.</p>

<h4 id="label-Anonymous+mappers">Anonymous mappers</h4>

<p>A lot of the time, mappers that you create will not be overly complicated, especially if you’re using automatic id properties. So, the <code>config.map</code> method optionally takes a block, and allows you to specify the mapper inline. This is recommended for mappers that aren’t too complicated as to warrant their own class (for instance, for testing purposes). An example of this using the <code>UserMapper</code> from above is below:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><span class='object_link'><a href="Humidifier.html" title="Humidifier (module)">Humidifier</a></span></span><span class='period'>.</span><span class='id identifier rubyid_configure'><span class='object_link'><a href="Humidifier.html#configure-class_method" title="Humidifier.configure (method)">configure</a></span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='symbol'>:users</span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>IAM::User</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
    <span class='const'>GROUPS</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>eng</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='qwords_beg'>%w[</span><span class='tstring_content'>Engineering</span><span class='words_sep'> </span><span class='tstring_content'>Testing</span><span class='words_sep'> </span><span class='tstring_content'>Deployment</span><span class='tstring_end'>]</span></span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='qwords_beg'>%w[</span><span class='tstring_content'>Management</span><span class='words_sep'> </span><span class='tstring_content'>Administration</span><span class='tstring_end'>]</span></span>
    <span class='rbrace'>}</span>

    <span class='id identifier rubyid_defaults'>defaults</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_logical_name'>logical_name</span><span class='op'>|</span>
      <span class='lbrace'>{</span> <span class='label'>path:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/humidifier/</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>user_name:</span> <span class='id identifier rubyid_logical_name'>logical_name</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_attribute'>attribute</span> <span class='symbol'>:group</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_group'>group</span><span class='op'>|</span>
      <span class='id identifier rubyid_groups'>groups</span> <span class='op'>=</span> <span class='const'>GROUPS</span><span class='lbracket'>[</span><span class='id identifier rubyid_group'>group</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_groups'>groups</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span> <span class='op'>?</span> <span class='lbrace'>{</span> <span class='label'>groups:</span> <span class='const'>GROUPS</span><span class='lbracket'>[</span><span class='id identifier rubyid_group'>group</span><span class='rbracket'>]</span> <span class='rbrace'>}</span> <span class='op'>:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h4 id="label-Cross-stack+references">Cross-stack references</h4>

<p>AWS allows cross-stack references through the <code>Fn::ImportValue</code> function[http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-importvalue.html]. You can take advantage of this with <code>humidifier</code> by using the <code>export: true</code> option on resources in your stacks. For instance, if in one stack you have a subnet that you need to reference in another, you could (<code>stacks/vpc/subnets.yml</code>):</p>

<pre class="code ruby"><code class="ruby">ProductionPrivateSubnet2a:
  vpc: ProductionVPC
  cidr_block: 10.0.0.0/19
  availability_zone: us-west-2a
  export: true

ProductionPrivateSubnet2b:
  vpc: ProductionVPC
  cidr_block: 10.0.64.0/19
  availability_zone: us-west-2b
  export: true

ProductionPrivateSubnet2c:
  vpc: ProductionVPC
  cidr_block: 10.0.128.0/19
  availability_zone: us-west-2c
  export: true
</code></pre>

<p>And then in another stack, you could reference those values (<code>stacks/rds/db_subnets_groups.yml</code>):</p>

<pre class="code ruby"><code class="ruby">ProductionDBSubnetGroup:
  db_subnet_group_description: Production DB private subnet group
  subnets:
  - ProductionPrivateSubnet2a
  - ProductionPrivateSubnet2b
  - ProductionPrivateSubnet2c
</code></pre>

<p>Within the configuration, you would specify to use the <code>Fn::ImportValue</code> function like so:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><span class='object_link'><a href="Humidifier.html" title="Humidifier (module)">Humidifier</a></span></span><span class='period'>.</span><span class='id identifier rubyid_configure'><span class='object_link'><a href="Humidifier.html#configure-class_method" title="Humidifier.configure (method)">configure</a></span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_stack_path'>stack_path</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>stacks</span><span class='tstring_end'>&#39;</span></span>

  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='symbol'>:subnets</span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>EC2::Subnet</span><span class='tstring_end'>&#39;</span></span>

  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='symbol'>:db_subnet_groups</span><span class='comma'>,</span> <span class='label'>to:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RDS::DBSubnetGroup</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_attribute'>attribute</span> <span class='symbol'>:subnets</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_subnet_names'>subnet_names</span><span class='op'>|</span>
      <span class='id identifier rubyid_subnet_ids'>subnet_ids</span> <span class='op'>=</span>
        <span class='id identifier rubyid_subnet_names'>subnet_names</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_subnet_name'>subnet_name</span><span class='op'>|</span>
          <span class='const'><span class='object_link'><a href="Humidifier.html" title="Humidifier (module)">Humidifier</a></span></span><span class='period'>.</span><span class='id identifier rubyid_fn'><span class='object_link'><a href="Humidifier.html#fn-class_method" title="Humidifier.fn (method)">fn</a></span></span><span class='period'>.</span><span class='id identifier rubyid_import_value'>import_value</span><span class='lparen'>(</span><span class='id identifier rubyid_subnet_name'>subnet_name</span><span class='rparen'>)</span>
        <span class='kw'>end</span>

      <span class='lbrace'>{</span> <span class='label'>subnet_ids:</span> <span class='id identifier rubyid_subnet_ids'>subnet_ids</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>If you specify <code>export: true</code> it will by default export a reference to the resource listed in the stack. You can also choose to export a different attribute by specifying the attribute as the value to export. For example, if we were creating instance profiles and wanted to export the <code>Arn</code> so that it could be referenced by an instance later, we could:</p>

<pre class="code ruby"><code class="ruby">APIRoleInstanceProfile:
  depends_on: APIRole
  roles:
  - APIRole
  export: Arn
</code></pre>

<h2 id="label-Development">Development</h2>

<p>To get started, ensure you have ruby installed, version 2.4 or later. From there, install the <code>bundler</code> gem: <code>gem install bundler</code> and then <code>bundle install</code> in the root of the repository.</p>

<h3 id="label-Testing">Testing</h3>

<p>The default rake task runs the tests. Styling is governed by rubocop. The docs are generated with yard. To run all three of these, run:</p>

<pre class="code ruby"><code class="ruby">$ bundle exec rake
$ bundle exec rubocop
$ bundle exec rake yard
</code></pre>

<h3 id="label-Specs">Specs</h3>

<p>The specs pulled from the CFN docs is saved to <code>CloudFormationResourceSpecification.json</code>. You can update it by running <code>bundle exec rake specs</code>. This script will pull down the latest <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-resource-specification.html">resource specification</a> to be used with Humidifier.</p>

<h3 id="label-Contributing">Contributing</h3>

<p>Bug reports and pull requests are welcome on GitHub at <a href="https://github.com/kddnewton/humidifier">github.com/kddnewton/humidifier</a>.</p>

<h3 id="label-License">License</h3>

<p>The gem is available as open source under the terms of the <a href="http://opensource.org/licenses/MIT">MIT License</a>.</p>
</div></div>

      <div id="footer">
   Generated by <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>.
</div>

    </div>
  </body>
</html>